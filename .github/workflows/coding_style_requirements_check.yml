name: Enforce absolute imports

on:
  pull_request:
    branches: [main]
    paths:
      - '**/*.py'
  workflow_dispatch:

jobs:
  import-check:
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v3

      - name: Enforce hdsemg_pipe-prefixed imports
        id: import_check
        continue-on-error: true
        shell: bash
        run: |
          # 1) Run the checker and write any errors to import_errors.txt
          python3 - <<'EOF' > import_errors.txt
          import ast, pathlib, sys
          
          ROOT = pathlib.Path('.')
          errors = []
          local_modules = {p.name for p in (ROOT/'hdsemg_pipe').iterdir() if p.is_dir()}
          local_modules.add('hdsemg_pipe')
          
          for path in ROOT.rglob('*.py'):
              if any(part in ('venv','.venv','__pycache__') for part in path.parts):
                  continue
              tree = ast.parse(path.read_text(encoding='utf-8'), filename=str(path))
              for node in ast.walk(tree):
                  if isinstance(node, ast.ImportFrom) and node.level == 0:
                      mod = node.module or ''
                      root_pkg = mod.split('.',1)[0]
                      if root_pkg in local_modules and not mod.startswith('hdsemg_pipe'):
                          errors.append(f"{path}:{node.lineno}: from {mod} import … → hdsemg_pipe.{mod}")
          
          if errors:
              for e in errors:
                  print(e)
              sys.exit(1)
          EOF
          # capture whether python exited with errors
          rc=$?

          # 2) Always publish the file into the step-output
          if [[ -s import_errors.txt ]]; then
            echo "errors<<EOF" >> $GITHUB_OUTPUT
            cat import_errors.txt >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "errors=All imports OK" >> $GITHUB_OUTPUT
          fi

          # 3) Now exit with the original python return code
          exit $rc


      - name: Comment on Pull Request (failure)
        if: ${{ github.event_name == 'pull_request' && github.base_ref == 'main' && steps.import_check.outcome == 'failure' }}
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ### ❌ Absolute-import check failed
            Please correct the imports in these files:
            ```
            ${{ steps.import_check.outputs.errors }}
            ```

      - name: Comment on Pull Request (success)
        if: ${{ github.event_name == 'pull_request' && github.base_ref == 'main' && steps.import_check.outcome == 'success' }}
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ### ✅ Absolute-Import Check succeeded
            All Python imports use the required absolute import style.

      - name: Fail if there were import errors
        if: ${{ steps.import_check.outcome == 'failure' }}
        run: exit 1
