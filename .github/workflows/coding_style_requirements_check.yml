name: Enforce absolute imports

on:
  pull_request:
    branches: [main]
    paths:
      - '**/*.py'
  workflow_dispatch:

jobs:
  import-check:
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v3

      # 1) Run Python import checks and capture errors without exiting the job
      - name: Enforce hdsemg_pipe-prefixed imports
        id: import_check
        continue-on-error: true
        run: |
          ERRORS=$(python3 - <<'EOF'
          import ast, pathlib, sys
          
          ROOT = pathlib.Path('.')
          errors = []
          local_modules = {p.name for p in (ROOT/'hdsemg_pipe').iterdir() if p.is_dir()}
          local_modules.add('hdsemg_pipe')
          
          for path in ROOT.rglob('*.py'):
              if any(part in ('venv','.venv','__pycache__') for part in path.parts):
                  continue
              tree = ast.parse(path.read_text(), filename=str(path))
              for node in ast.walk(tree):
                  if isinstance(node, ast.ImportFrom) and node.level == 0:
                      mod = node.module or ''
                      root_pkg = mod.split('.',1)[0]
                      if root_pkg in local_modules and not mod.startswith('hdsemg_pipe'):
                          errors.append(f"{path}:{node.lineno}: from {mod} import … → hdsemg_pipe.{mod}")
          if errors:
              echo "::set-output name=errors::$(printf '%s\n' \"${errors[@]}\")"
              exit 1
          EOF
          )
        shell: bash

      # 2) Only comment on PRs targeting main when the import check failed
      - name: Comment on Pull Request
        if: ${{ github.event_name == 'pull_request' && github.base_ref == 'main' && steps.import_check.outcome == 'failure' }}
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ### ❌ Absolute-import check failed
            Please correct the imports in these files:
            ```
            ${{ steps.import_check.outputs.errors }}
            ```

      # 3) Finally, fail the job so the PR is blocked by this status check
      - name: Fail if there were import errors
        if: ${{ steps.import_check.outcome == 'failure' }}
        run: exit 1
