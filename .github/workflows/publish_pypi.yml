name: Build & Publish

on:
  push:
    tags:
      - 'v*'

jobs:

  publish-testpypi:
    if: contains(github.ref_name, 'dev') || contains(github.ref_name, 'rc') ||
        contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') ||
        contains(github.ref_name, 'test')
    runs-on: ubuntu-latest
    environment: testpypi
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with: { python-version: '3.10' }

      - name: Install & build
        run: |
          python -m pip install --upgrade pip build twine
          python -m build

      - name: Publish to TestPyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.TEST_PYPI_TOKEN }}
        run: twine upload --repository-url https://test.pypi.org/legacy/ dist/*

  publish-pypi:
    if: ${{ !contains(github.ref_name, 'dev') && !contains(github.ref_name, 'rc') &&
            !contains(github.ref_name, 'alpha') && !contains(github.ref_name, 'beta') &&
            !contains(github.ref_name, 'test') }}
    runs-on: ubuntu-latest
    environment: pypi
    permissions:
      contents: write
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with: { python-version: '3.10' }

      - name: Install & build
        run: |
          python -m pip install --upgrade pip build twine
          python -m build

      - name: Publish to PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_TOKEN }}
        run: twine upload dist/*

      - name: Gather Release Notes
        id: notes
        shell: bash
        run: |
          PREV_TAG=$(git tag --sort=-creatordate | sed -n '2p') || true
          echo '<!-- Auto-generated. Do not edit. -->' > release-notes.md
          echo >> release-notes.md
          cat README.md >> release-notes.md
          echo >> release-notes.md && echo '## Changelog' >> release-notes.md && echo >> release-notes.md
          if [ -n "$PREV_TAG" ]; then
            git log "$PREV_TAG..${GITHUB_REF_NAME}" \
              --pretty=format:'- [`%h`](https://github.com/${{ github.repository }}/commit/%H) %s' \
              >> release-notes.md
          else
            echo '- Initial release' >> release-notes.md
          fi
          echo "notes_file=release-notes.md" >>"$GITHUB_OUTPUT"

      - name: Create release
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag:   ${{ github.ref_name }}
          name:  Release ${{ github.ref_name }}
          bodyFile: ${{ steps.notes.outputs.notes_file }}
